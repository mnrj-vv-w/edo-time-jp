/**
 * 七十二候判定
 * 72 Micro-Seasons Determination
 * 
 * 太陽黄経から直接候を判定する（5度刻み、360°÷72=5°）。
 * 理論的でシンプル、後で説明しやすい設計。
 * 
 * Determines 72 micro-seasons directly from solar longitude (5-degree intervals, 360°÷72=5°).
 * Theoretical and simple design that is easy to explain later.
 */

import type { Sekki72 } from './types';
import { SOLAR_TERMS } from './solar-terms';

/**
 * 七十二候の定義テーブル（内部用）
 * 72 Micro-Seasons Definition Table (Internal)
 * 
 * 各候の名称を定義する。黄経5度刻み、360°÷72=5°。
 * 
 * Defines the name of each micro-season. 5-degree intervals, 360°÷72=5°.
 */
const SEKKI_72: Sekki72[] = [
  // 立春（黄経315度）
  "東風解凍", "黄鶯睍睆", "魚上氷",
  // 雨水（黄経330度）
  "土脉潤起", "霞始靆", "草木萌動",
  // 啓蟄（黄経345度）
  "蟄虫啓戸", "桃始笑", "菜虫化蝶",
  // 春分（黄経0度）
  "雀始巣", "櫻始開", "雷乃発声",
  // 清明（黄経15度）
  "玄鳥至", "鴻雁北", "虹始見",
  // 穀雨（黄経30度）
  "葭始生", "霜止出苗", "牡丹華",
  // 立夏（黄経45度）
  "鼃始鳴", "蚯蚓出", "竹笋生",
  // 小満（黄経60度）
  "蚕起食桑", "紅花栄", "麦秋至",
  // 芒種（黄経75度）
  "蟷螂生", "腐草為蛍", "梅子黄",
  // 夏至（黄経90度）
  "乃東枯", "菖蒲華", "半夏生",
  // 小暑（黄経105度）
  "温風至", "蓮始開", "鷹乃学習",
  // 大暑（黄経120度）
  "桐始結花", "土潤溽暑", "大雨時行",
  // 立秋（黄経135度）
  "涼風至", "寒蝉鳴", "蒙霧升降",
  // 処暑（黄経150度）
  "綿柎開", "天地始粛", "禾乃登",
  // 白露（黄経165度）
  "草露白", "鶺鴒鳴", "玄鳥去",
  // 秋分（黄経180度）
  "雷乃収声", "蟄虫坏戸", "水始涸",
  // 寒露（黄経195度）
  "鴻雁来", "菊花開", "蟋蟀在戸",
  // 霜降（黄経210度）
  "霜始降", "霎時施", "楓蔦黄",
  // 立冬（黄経225度）
  "山茶始開", "地始凍", "金盞香",
  // 小雪（黄経240度）
  "虹蔵不見", "朔風払葉", "橘始黄",
  // 大雪（黄経255度）
  "閉塞成冬", "熊蟄穴", "鱖魚群",
  // 冬至（黄経270度）
  "乃東生", "麋角解", "雪下出麦",
  // 小寒（黄経285度）
  "芹乃栄", "水泉動", "雉始雊",
  // 大寒（黄経300度）
  "款冬華", "水沢腹堅", "鶏始乳",
];

/**
 * 七十二候の読み仮名
 */
export const SEKKI_72_READINGS: Record<string, string> = {
  // 立春
  "東風解凍": "とうふうかいとう",
  "黄鶯睍睆": "うぐいすなく",
  "魚上氷": "うおこおりをいずる",
  // 雨水
  "土脉潤起": "つちのしょううるおいおこる",
  "霞始靆": "かすみはじめてたなびく",
  "草木萌動": "そうもくめばえいずる",
  // 啓蟄
  "蟄虫啓戸": "すごもりむしとをひらく",
  "桃始笑": "ももはじめてさく",
  "菜虫化蝶": "なむしちょうとなる",
  // 春分
  "雀始巣": "すずめはじめてすくう",
  "櫻始開": "さくらはじめてひらく",
  "雷乃発声": "かみなりすなわちこえをはっす",
  // 清明
  "玄鳥至": "つばめきたる",
  "鴻雁北": "こうがんきたへかえる",
  "虹始見": "にじはじめてあらわる",
  // 穀雨
  "葭始生": "あしはじめてしょうず",
  "霜止出苗": "しもやみてなえいずる",
  "牡丹華": "ぼたんはなさく",
  // 立夏
  "鼃始鳴": "かわずはじめてなく",
  "蚯蚓出": "みみずいずる",
  "竹笋生": "たけのこしょうず",
  // 小満
  "蚕起食桑": "かいこおきてくわをくう",
  "紅花栄": "べにばなさかう",
  "麦秋至": "むぎのときいたる",
  // 芒種
  "蟷螂生": "かまきりしょうず",
  "腐草為蛍": "くされたるくさほたるとなる",
  "梅子黄": "うめのみきばむ",
  // 夏至
  "乃東枯": "なつかれくさかるる",
  "菖蒲華": "あやめはなさく",
  "半夏生": "はんげしょうず",
  // 小暑
  "温風至": "あつかぜいたる",
  "蓮始開": "はすはじめてひらく",
  "鷹乃学習": "たかすなわちわざをならう",
  // 大暑
  "桐始結花": "きりはじめてはなをむすぶ",
  "土潤溽暑": "つちうるおいてむしあつし",
  "大雨時行": "たいうときどきにふる",
  // 立秋
  "涼風至": "すずかぜいたる",
  "寒蝉鳴": "ひぐらしなく",
  "蒙霧升降": "ふかききりまとう",
  // 処暑
  "綿柎開": "わたのはなしべひらく",
  "天地始粛": "てんちはじめてさむし",
  "禾乃登": "こくものすなわちみのる",
  // 白露
  "草露白": "くさのつゆしろし",
  "鶺鴒鳴": "せきれいなく",
  "玄鳥去": "つばめさる",
  // 秋分
  "雷乃収声": "かみなりすなわちこえをおさむ",
  "蟄虫坏戸": "むしかくれてとをふさぐ",
  "水始涸": "みずはじめてかるる",
  // 寒露
  "鴻雁来": "こうがんきたる",
  "菊花開": "きくのはなひらく",
  "蟋蟀在戸": "きりぎりすとにあり",
  // 霜降
  "霜始降": "しもはじめてふる",
  "霎時施": "こさめときどきふる",
  "楓蔦黄": "もみじつたきばむ",
  // 立冬
  "山茶始開": "つばきはじめてひらく",
  "地始凍": "ちはじめてこおる",
  "金盞香": "きんせんかさく",
  // 小雪
  "虹蔵不見": "にじかくれてみえず",
  "朔風払葉": "きたかぜこのはをはらう",
  "橘始黄": "たちばなはじめてきばむ",
  // 大雪
  "閉塞成冬": "そらさむくふゆとなる",
  "熊蟄穴": "くまあなにこもる",
  "鱖魚群": "さけのうおむらがる",
  // 冬至
  "乃東生": "なつかれくさしょうず",
  "麋角解": "さわしかのつのおつる",
  "雪下出麦": "ゆきわたりてむぎのびる",
  // 小寒
  "芹乃栄": "せりすなわちさかう",
  "水泉動": "しみずあたたかをふくむ",
  "雉始雊": "きじはじめてなく",
  // 大寒
  "款冬華": "ふきのはなさく",
  "水沢腹堅": "さわみずこおりつめる",
  "鶏始乳": "にわとりはじめてとやにつく",
};

/**
 * 七十二候の説明文（日本の意味）
 */
export const SEKKI_72_DESCRIPTIONS: Record<string, string> = {
  // 立春
  "東風解凍": "東風が吹いて、氷が解け始める時期。春の訪れを感じさせる。",
  "黄鶯睍睆": "うぐいすが美しい声で鳴き始める時期。",
  "魚上氷": "氷の下で泳いでいた魚が、氷の上に跳ね上がる時期。",
  // 雨水
  "土脉潤起": "大地が潤い、土が湿り気を帯び始める時期。",
  "霞始靆": "霞が立ち始める時期。遠くの景色がぼやけて見える。",
  "草木萌動": "草木が芽吹き始める時期。",
  // 啓蟄
  "蟄虫啓戸": "冬ごもりしていた虫が、土の中から出てくる時期。",
  "桃始笑": "桃の花が咲き始める時期。",
  "菜虫化蝶": "青虫がさなぎから蝶に変わる時期。",
  // 春分
  "雀始巣": "すずめが巣を作り始める時期。",
  "櫻始開": "桜の花が咲き始める時期。",
  "雷乃発声": "春雷が鳴り始める時期。",
  // 清明
  "玄鳥至": "つばめが南から渡ってくる時期。",
  "鴻雁北": "雁が北へ帰っていく時期。",
  "虹始見": "雨上がりに虹が見え始める時期。",
  // 穀雨
  "葭始生": "葦（あし）が芽を出し始める時期。",
  "霜止出苗": "霜が降りなくなり、稲の苗が育つ時期。",
  "牡丹華": "牡丹の花が咲く時期。",
  // 立夏
  "鼃始鳴": "かえるが鳴き始める時期。",
  "蚯蚓出": "みみずが地上に這い出る時期。",
  "竹笋生": "たけのこが生えてくる時期。",
  // 小満
  "蚕起食桑": "蚕が桑の葉を食べ始める時期。",
  "紅花栄": "紅花が咲き誇る時期。",
  "麦秋至": "麦が実り、収穫の時期を迎える。",
  // 芒種
  "蟷螂生": "かまきりが生まれる時期。",
  "腐草為蛍": "腐った草が蛍になる（蛍が光り始める）時期。",
  "梅子黄": "梅の実が黄色く熟す時期。",
  // 夏至
  "乃東枯": "夏枯草（かごそう）が枯れる時期。",
  "菖蒲華": "あやめの花が咲く時期。",
  "半夏生": "半夏（はんげ）が生える時期。",
  // 小暑
  "温風至": "温かい風が吹き始める時期。",
  "蓮始開": "蓮の花が咲き始める時期。",
  "鷹乃学習": "鷹の幼鳥が飛び方を覚える時期。",
  // 大暑
  "桐始結花": "桐の花が咲き始める時期。",
  "土潤溽暑": "土が湿り、蒸し暑くなる時期。",
  "大雨時行": "大雨が降る時期。",
  // 立秋
  "涼風至": "涼しい風が吹き始める時期。",
  "寒蝉鳴": "ひぐらしが鳴き始める時期。",
  "蒙霧升降": "深い霧が立ち込める時期。",
  // 処暑
  "綿柎開": "綿の実がはじける時期。",
  "天地始粛": "天地の気が次第に静まる時期。",
  "禾乃登": "穀物が実る時期。",
  // 白露
  "草露白": "草に白い露が降りる時期。",
  "鶺鴒鳴": "せきれいが鳴く時期。",
  "玄鳥去": "つばめが南へ帰っていく時期。",
  // 秋分
  "雷乃収声": "雷が鳴らなくなる時期。",
  "蟄虫坏戸": "虫が土の中に隠れる時期。",
  "水始涸": "田の水が干上がり始める時期。",
  // 寒露
  "鴻雁来": "雁が渡ってくる時期。",
  "菊花開": "菊の花が咲く時期。",
  "蟋蟀在戸": "こおろぎが戸口で鳴く時期。",
  // 霜降
  "霜始降": "霜が降り始める時期。",
  "霎時施": "小雨がしとしと降る時期。",
  "楓蔦黄": "もみじやつたが黄葉する時期。",
  // 立冬
  "山茶始開": "山茶花（さざんか）が咲き始める時期。",
  "地始凍": "大地が凍り始める時期。",
  "金盞香": "水仙の花が咲く時期。",
  // 小雪
  "虹蔵不見": "虹が見えなくなる時期。空気が乾燥し、虹が発生しにくくなる。",
  "朔風払葉": "北風が木の葉を払い落とす時期。",
  "橘始黄": "橘の実が黄色く色づく時期。",
  // 大雪
  "閉塞成冬": "天地の気が閉ざされ、本格的な冬になる時期。",
  "熊蟄穴": "熊が冬ごもりに入る時期。",
  "鱖魚群": "さけが群れをなして川を上る時期。",
  // 冬至
  "乃東生": "夏枯草が芽を出す時期。",
  "麋角解": "大鹿の角が落ちる時期。",
  "雪下出麦": "雪の下で麦が芽を出す時期。",
  // 小寒
  "芹乃栄": "せりがよく育つ時期。",
  "水泉動": "凍っていた泉の水が動き始める時期。",
  "雉始雊": "きじが鳴き始める時期。",
  // 大寒
  "款冬華": "ふきのとうが咲く時期。",
  "水沢腹堅": "沢の水が厚く凍る時期。",
  "鶏始乳": "にわとりが卵を産み始める時期。",
};

/**
 * 各節気名からSEKKI_72配列の開始インデックスへのマッピング
 * Mapping from solar term name to SEKKI_72 array start index
 * 
 * SEKKI_72配列は立春（315度）から始まる順序
 * SEKKI_72 array starts from Risshun (315 degrees) in order
 */
const SEKKI_72_INDEX_MAP: Record<string, number> = {
  "立春": 0,   // 315度
  "雨水": 3,   // 330度
  "啓蟄": 6,   // 345度
  "春分": 9,   // 0度
  "清明": 12,  // 15度
  "穀雨": 15,  // 30度
  "立夏": 18,  // 45度
  "小満": 21,  // 60度
  "芒種": 24,  // 75度
  "夏至": 27,  // 90度
  "小暑": 30,  // 105度
  "大暑": 33,  // 120度
  "立秋": 36,  // 135度
  "処暑": 39,  // 150度
  "白露": 42,  // 165度
  "秋分": 45,  // 180度
  "寒露": 48,  // 195度
  "霜降": 51,  // 210度
  "立冬": 54,  // 225度
  "小雪": 57,  // 240度
  "大雪": 60,  // 255度
  "冬至": 63,  // 270度
  "小寒": 66,  // 285度
  "大寒": 69,  // 300度
};

/**
 * 太陽黄経から七十二候を判定する
 * Determine 72 micro-seasons from solar longitude
 * 
 * 各節気の開始点から候を判定する。
 * 各節気は15度、各候は5度（15度÷3=5度）。
 * 
 * Determines micro-seasons from each solar term's starting point.
 * Each solar term is 15 degrees, each micro-season is 5 degrees (15°÷3=5°).
 * 
 * @param solarLongitude - 太陽黄経（度、0-360）/ Solar longitude (degrees, 0-360)
 * @returns 七十二候の名称 / Name of 72 micro-seasons
 */
export function getSekki72(solarLongitude: number): Sekki72 {
  // 0-360度の範囲に正規化
  // Normalize to 0-360 degree range
  let normalized = solarLongitude % 360;
  if (normalized < 0) {
    normalized += 360;
  }
  
  // まず、どの節気の範囲内かを判定
  // First, determine which solar term's range we're in
  let currentSekki: { longitude: number; term: string } | null = null;
  for (let i = 0; i < SOLAR_TERMS.length; i++) {
    const current = SOLAR_TERMS[i];
    const next = SOLAR_TERMS[(i + 1) % SOLAR_TERMS.length];
    
    let nextLongitude = next.longitude;
    if (nextLongitude < current.longitude) {
      nextLongitude += 360;
    }
    
    let normalizedNext = normalized;
    if (normalizedNext < current.longitude) {
      normalizedNext += 360;
    }
    
    if (normalizedNext >= current.longitude && normalizedNext < nextLongitude) {
      currentSekki = current;
      break;
    }
  }
  
  if (!currentSekki) {
    currentSekki = SOLAR_TERMS[0]; // フォールバック / Fallback
  }
  
  // 節気内での位置を計算（0-15度の範囲）
  // Calculate position within the solar term (0-15 degree range)
  let offsetInSekki = normalized - currentSekki.longitude;
  if (offsetInSekki < 0) {
    offsetInSekki += 360;
  }
  
  // 節気内のどの候か（0, 1, 2）
  // Which micro-season within the solar term (0, 1, 2)
  // 各節気は15度、各候は5度（15度÷3=5度）
  // Each solar term is 15 degrees, each micro-season is 5 degrees (15°÷3=5°)
  const kouIndex = Math.min(2, Math.floor(offsetInSekki / 5)); // 0, 1, 2のいずれか / Either 0, 1, or 2
  
  // 節気名からSEKKI_72配列の開始インデックスを取得
  // Get SEKKI_72 array start index from solar term name
  const baseIndex = SEKKI_72_INDEX_MAP[currentSekki.term];
  if (baseIndex === undefined) {
    // フォールバック: 黄経から直接計算（旧実装）
    // Fallback: calculate directly from longitude (old implementation)
    const index = Math.floor(normalized / 5) % 72;
    return SEKKI_72[index];
  }
  
  // 七十二候の配列インデックスを計算
  // Calculate the 72 micro-seasons array index
  const index = baseIndex + kouIndex;
  
  return SEKKI_72[index];
}

/**
 * 七十二候の配列（5度刻み順）
 * UI表示用に公開
 */
export const SEKKI_72_LIST = SEKKI_72;

